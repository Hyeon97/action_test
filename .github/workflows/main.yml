name: Build and Push to NCP Container Registry

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]

# GitHub Actions ê¶Œí•œ ì„¤ì •
permissions:
  contents: read
  packages: write

env:
  PROJECT_NAME: zdm-api-server
  REGISTRY_URL: zcon-nipa-container-registry.kr.ncr.ntruss.com
  NODE_VERSION: '22'

jobs:
  # 1ë‹¨ê³„: ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    
    outputs:
      version: ${{ steps.version.outputs.version }}
    
    steps:
    - name: ğŸ›’ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Node.js ${{ env.NODE_VERSION }} ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
      run: npm ci
      
    - name: ğŸ§ª TypeScript ë¹Œë“œ í…ŒìŠ¤íŠ¸
      run: |
        echo "ğŸ” Testing TypeScript build..."
        npm run build
        echo "âœ… TypeScript build successful"
        
    - name: ğŸ·ï¸ ë²„ì „ ì •ë³´ ìƒì„±
      id: version
      run: |
        # íƒœê·¸ê°€ ìˆìœ¼ë©´ íƒœê·¸ë¥¼ ì‚¬ìš©, ì—†ìœ¼ë©´ ë¸Œëœì¹˜-SHA ì¡°í•© ì‚¬ìš©
        if [[ $GITHUB_REF == refs/tags/* ]]; then
          VERSION=${GITHUB_REF#refs/tags/}
        else
          VERSION=${{ github.ref_name }}-${{ github.sha }}
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "ğŸ“ Generated version: $VERSION"
        
    - name: ğŸ“¤ ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts-${{ steps.version.outputs.version }}
        path: |
          dist/
          package.json
          package-lock.json
        retention-days: 1

  # 2ë‹¨ê³„: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
  docker-build-push:
    name: Docker Build and Push to NCP
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.event_name == 'push'
    
    steps:
    - name: ğŸ›’ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Docker Buildx ì„¤ì •
      uses: docker/setup-buildx-action@v3
      
    - name: ğŸ” NCP Container Registry ë¡œê·¸ì¸
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY_URL }}
        username: ${{ secrets.NCP_REGISTRY_USERNAME }}
        password: ${{ secrets.NCP_REGISTRY_PASSWORD }}
        
    - name: ğŸ·ï¸ ë©”íƒ€ë°ì´í„° ì¶”ì¶œ
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY_URL }}/${{ env.PROJECT_NAME }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=sha,prefix={{branch}}-
          type=raw,value=latest,enable={{is_default_branch}}
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
        labels: |
          org.opencontainers.image.title=${{ env.PROJECT_NAME }}
          org.opencontainers.image.description=TypeScript Server for ${{ env.PROJECT_NAME }}
          org.opencontainers.image.vendor=Your Organization
          
    - name: ğŸ³ Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        platforms: linux/amd64
        
    - name: ğŸ“‹ í‘¸ì‹œëœ ì´ë¯¸ì§€ ì •ë³´ ì¶œë ¥
      run: |
        echo "ğŸ‰ Successfully pushed to NCP Container Registry!"
        echo "ğŸ“ Registry: ${{ env.REGISTRY_URL }}"
        echo "ğŸ“ Repository: ${{ env.PROJECT_NAME }}"
        echo "ğŸ“ Tags:"
        echo "${{ steps.meta.outputs.tags }}" | while read tag; do
          echo "   - $tag"
        done
        
    - name: ğŸ§¹ ë¹Œë“œ ìºì‹œ ì •ë¦¬
      run: |
        echo "ğŸ§¹ Cleaning up build cache..."
        docker builder prune -f
        echo "âœ… Build cache cleaned up"

  # 3ë‹¨ê³„: ì´ë¯¸ì§€ ê²€ì¦
  verify-image:
    name: Verify Pushed Image
    runs-on: ubuntu-latest
    needs: docker-build-push
    if: github.event_name == 'push'
    
    steps:
    - name: ğŸ” NCP Container Registry ë¡œê·¸ì¸
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY_URL }}
        username: ${{ secrets.NCP_REGISTRY_USERNAME }}
        password: ${{ secrets.NCP_REGISTRY_PASSWORD }}
        
    - name: ğŸ” ì´ë¯¸ì§€ ê²€ì¦
      run: |
        echo "ğŸ” Verifying pushed image..."
        
        # latest íƒœê·¸ ì´ë¯¸ì§€ í’€ í…ŒìŠ¤íŠ¸
        IMAGE_NAME="${{ env.REGISTRY_URL }}/${{ env.PROJECT_NAME }}:latest"
        echo "ğŸ“¦ Pulling image: $IMAGE_NAME"
        
        if docker pull "$IMAGE_NAME"; then
          echo "âœ… Image pull successful"
          
          # ì´ë¯¸ì§€ ì •ë³´ ì¶œë ¥
          echo "ğŸ“‹ Image information:"
          docker images "$IMAGE_NAME" --format "table {{.Repository}}\t{{.Tag}}\t{{.ID}}\t{{.CreatedAt}}\t{{.Size}}"
          
          # ê°„ë‹¨í•œ ì‹¤í–‰ í…ŒìŠ¤íŠ¸
          echo "ğŸš€ Testing container startup..."
          CONTAINER_ID=$(docker run -d -p 8080:53307 "$IMAGE_NAME")
          
          # ì»¨í…Œì´ë„ˆ ì‹œì‘ ëŒ€ê¸°
          sleep 15
          
          # í—¬ìŠ¤ì²´í¬
          if docker ps | grep -q "$CONTAINER_ID"; then
            echo "âœ… Container is running"
            
            # HTTP ì‘ë‹µ í…ŒìŠ¤íŠ¸ (í¬íŠ¸í¬ì›Œë”© ì—†ì´ ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì—ì„œ)
            if docker exec "$CONTAINER_ID" wget -q --spider http://localhost:53307/; then
              echo "âœ… Application is responding"
            else
              echo "âš ï¸ Application health check failed"
              docker logs "$CONTAINER_ID"
            fi
          else
            echo "âŒ Container failed to start"
            docker logs "$CONTAINER_ID"
          fi
          
          # ì •ë¦¬
          docker stop "$CONTAINER_ID" > /dev/null 2>&1
          docker rm "$CONTAINER_ID" > /dev/null 2>&1
          
        else
          echo "âŒ Image pull failed"
          exit 1
        fi

  # 4ë‹¨ê³„: GitHub Release ìƒì„±
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-and-test, docker-build-push, verify-image]
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
    
    outputs:
      release-url: ${{ steps.create_release.outputs.html_url }}
      upload-url: ${{ steps.create_release.outputs.upload_url }}
    
    steps:
    - name: ğŸ›’ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # ì „ì²´ íˆìŠ¤í† ë¦¬ ê°€ì ¸ì˜¤ê¸° (ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ìƒì„±ìš©)
        
    - name: ğŸ“ ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ìƒì„±
      id: release_notes
      run: |
        TAG_NAME=${GITHUB_REF#refs/tags/}
        echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
        
        # ì´ì „ íƒœê·¸ ì°¾ê¸°
        PREVIOUS_TAG=$(git describe --tags --abbrev=0 "$TAG_NAME^" 2>/dev/null || echo "")
        
        # ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ìƒì„±
        RELEASE_NOTES_FILE="release_notes.md"
        
        echo "# ğŸš€ $TAG_NAME Release" > $RELEASE_NOTES_FILE
        echo "" >> $RELEASE_NOTES_FILE
        
        # Docker ì´ë¯¸ì§€ ì •ë³´ ì¶”ê°€
        echo "## ğŸ“¦ Docker Images" >> $RELEASE_NOTES_FILE
        echo "" >> $RELEASE_NOTES_FILE
        echo "```bash" >> $RELEASE_NOTES_FILE
        echo "# Pull the latest image" >> $RELEASE_NOTES_FILE
        echo "docker pull ${{ env.REGISTRY_URL }}/${{ env.PROJECT_NAME }}:$TAG_NAME" >> $RELEASE_NOTES_FILE
        echo "docker pull ${{ env.REGISTRY_URL }}/${{ env.PROJECT_NAME }}:latest" >> $RELEASE_NOTES_FILE
        echo "" >> $RELEASE_NOTES_FILE
        echo "# Run the container" >> $RELEASE_NOTES_FILE
        echo "docker run -d -p 53307:53307 ${{ env.REGISTRY_URL }}/${{ env.PROJECT_NAME }}:$TAG_NAME" >> $RELEASE_NOTES_FILE
        echo "```" >> $RELEASE_NOTES_FILE
        echo "" >> $RELEASE_NOTES_FILE
        
        # ë³€ê²½ì‚¬í•­ ì¶”ê°€
        echo "## ğŸ“‹ Changes" >> $RELEASE_NOTES_FILE
        echo "" >> $RELEASE_NOTES_FILE
        
        if [ -n "$PREVIOUS_TAG" ]; then
          echo "### ğŸ”„ Changes since $PREVIOUS_TAG" >> $RELEASE_NOTES_FILE
          echo "" >> $RELEASE_NOTES_FILE
          
          # ì»¤ë°‹ ë¡œê·¸ ìƒì„±
          git log --pretty=format:"- %s (%h)" "$PREVIOUS_TAG..$TAG_NAME" >> $RELEASE_NOTES_FILE || echo "- Initial release" >> $RELEASE_NOTES_FILE
        else
          echo "### ğŸ‰ Initial Release" >> $RELEASE_NOTES_FILE
          echo "" >> $RELEASE_NOTES_FILE
          echo "- First release of ${{ env.PROJECT_NAME }}" >> $RELEASE_NOTES_FILE
        fi
        
        echo "" >> $RELEASE_NOTES_FILE
        
        # ê¸°ìˆ  ì •ë³´ ì¶”ê°€
        echo "## ğŸ”§ Technical Information" >> $RELEASE_NOTES_FILE
        echo "" >> $RELEASE_NOTES_FILE
        echo "- **Node.js Version**: ${{ env.NODE_VERSION }}" >> $RELEASE_NOTES_FILE
        echo "- **Build Date**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $RELEASE_NOTES_FILE
        echo "- **Git Commit**: \`${{ github.sha }}\`" >> $RELEASE_NOTES_FILE
        echo "- **Docker Registry**: ${{ env.REGISTRY_URL }}" >> $RELEASE_NOTES_FILE
        echo "" >> $RELEASE_NOTES_FILE
        
        # ë°°í¬ ê°€ì´ë“œ ì¶”ê°€
        echo "## ğŸš€ Deployment" >> $RELEASE_NOTES_FILE
        echo "" >> $RELEASE_NOTES_FILE
        echo "### Kubernetes Deployment" >> $RELEASE_NOTES_FILE
        echo "```yaml" >> $RELEASE_NOTES_FILE
        echo "apiVersion: apps/v1" >> $RELEASE_NOTES_FILE
        echo "kind: Deployment" >> $RELEASE_NOTES_FILE
        echo "metadata:" >> $RELEASE_NOTES_FILE
        echo "  name: ${{ env.PROJECT_NAME }}" >> $RELEASE_NOTES_FILE
        echo "spec:" >> $RELEASE_NOTES_FILE
        echo "  replicas: 3" >> $RELEASE_NOTES_FILE
        echo "  template:" >> $RELEASE_NOTES_FILE
        echo "    spec:" >> $RELEASE_NOTES_FILE
        echo "      containers:" >> $RELEASE_NOTES_FILE
        echo "      - name: app" >> $RELEASE_NOTES_FILE
        echo "        image: ${{ env.REGISTRY_URL }}/${{ env.PROJECT_NAME }}:$TAG_NAME" >> $RELEASE_NOTES_FILE
        echo "        ports:" >> $RELEASE_NOTES_FILE
        echo "        - containerPort: 53307" >> $RELEASE_NOTES_FILE
        echo "```" >> $RELEASE_NOTES_FILE
        echo "" >> $RELEASE_NOTES_FILE
        
        # ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ë‚´ìš©ì„ GitHub Outputìœ¼ë¡œ ì„¤ì •
        {
          echo 'release_notes<<EOF'
          cat $RELEASE_NOTES_FILE
          echo 'EOF'
        } >> $GITHUB_OUTPUT
        
        echo "ğŸ“ Release notes generated for $TAG_NAME"
        cat $RELEASE_NOTES_FILE
        
    - name: ğŸ‰ GitHub Release ìƒì„±
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.release_notes.outputs.tag_name }}
        release_name: "Release ${{ steps.release_notes.outputs.tag_name }}"
        body: ${{ steps.release_notes.outputs.release_notes }}
        draft: false
        prerelease: ${{ contains(steps.release_notes.outputs.tag_name, 'alpha') || contains(steps.release_notes.outputs.tag_name, 'beta') || contains(steps.release_notes.outputs.tag_name, 'rc') }}
        
    - name: ğŸ“¦ ë¦´ë¦¬ì¦ˆ ì•„í‹°íŒ©íŠ¸ ì¤€ë¹„
      run: |
        # ë¦´ë¦¬ì¦ˆì— ì²¨ë¶€í•  íŒŒì¼ë“¤ ì¤€ë¹„
        mkdir -p release-artifacts
        
        # package.json ë³µì‚¬
        cp package.json release-artifacts/
        
        # Docker ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
        cat > release-artifacts/run-docker.sh << 'EOF'
        #!/bin/bash
        # ${{ env.PROJECT_NAME }} ${{ steps.release_notes.outputs.tag_name }} ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸
        
        echo "ğŸš€ Starting ${{ env.PROJECT_NAME }} ${{ steps.release_notes.outputs.tag_name }}"
        
        # ì´ë¯¸ì§€ í’€
        docker pull ${{ env.REGISTRY_URL }}/${{ env.PROJECT_NAME }}:${{ steps.release_notes.outputs.tag_name }}
        
        # ì»¨í…Œì´ë„ˆ ì‹¤í–‰
        docker run -d \
          --name ${{ env.PROJECT_NAME }}-${{ steps.release_notes.outputs.tag_name }} \
          -p 53307:53307 \
          --restart unless-stopped \
          ${{ env.REGISTRY_URL }}/${{ env.PROJECT_NAME }}:${{ steps.release_notes.outputs.tag_name }}
        
        echo "âœ… ${{ env.PROJECT_NAME }} started on port 53307"
        echo "ğŸŒ Access: http://localhost:53307"
        EOF
        
        chmod +x release-artifacts/run-docker.sh
        
        # Kubernetes ë°°í¬ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ìƒì„±
        cat > release-artifacts/k8s-deployment.yaml << EOF
        apiVersion: apps/v1
        kind: Deployment
        metadata:
          name: ${{ env.PROJECT_NAME }}
          labels:
            app: ${{ env.PROJECT_NAME }}
            version: ${{ steps.release_notes.outputs.tag_name }}
        spec:
          replicas: 3
          selector:
            matchLabels:
              app: ${{ env.PROJECT_NAME }}
          template:
            metadata:
              labels:
                app: ${{ env.PROJECT_NAME }}
                version: ${{ steps.release_notes.outputs.tag_name }}
            spec:
              containers:
              - name: app
                image: ${{ env.REGISTRY_URL }}/${{ env.PROJECT_NAME }}:${{ steps.release_notes.outputs.tag_name }}
                ports:
                - containerPort: 53307
                env:
                - name: PORT
                  value: "53307"
                - name: NODE_ENV
                  value: "production"
                resources:
                  requests:
                    memory: "256Mi"
                    cpu: "250m"
                  limits:
                    memory: "512Mi"
                    cpu: "500m"
                livenessProbe:
                  httpGet:
                    path: /
                    port: 53307
                  initialDelaySeconds: 30
                  periodSeconds: 10
                readinessProbe:
                  httpGet:
                    path: /
                    port: 53307
                  initialDelaySeconds: 5
                  periodSeconds: 5
        ---
        apiVersion: v1
        kind: Service
        metadata:
          name: ${{ env.PROJECT_NAME }}-service
          labels:
            app: ${{ env.PROJECT_NAME }}
        spec:
          selector:
            app: ${{ env.PROJECT_NAME }}
          ports:
          - name: http
            port: 80
            targetPort: 53307
            protocol: TCP
          type: ClusterIP
        EOF
        
        # ì•„í‹°íŒ©íŠ¸ ëª©ë¡ ìƒì„±
        cat > release-artifacts/README.md << EOF
        # ${{ env.PROJECT_NAME }} ${{ steps.release_notes.outputs.tag_name }} Release Files
        
        ## ğŸ“¦ í¬í•¨ëœ íŒŒì¼ë“¤
        
        - \`package.json\`: í”„ë¡œì íŠ¸ ì˜ì¡´ì„± ì •ë³´
        - \`run-docker.sh\`: Docker ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸
        - \`k8s-deployment.yaml\`: Kubernetes ë°°í¬ ë§¤ë‹ˆí˜ìŠ¤íŠ¸
        - \`README.md\`: ì´ íŒŒì¼
        
        ## ğŸš€ ë¹ ë¥¸ ì‹œì‘
        
        ### Dockerë¡œ ì‹¤í–‰
        \`\`\`bash
        chmod +x run-docker.sh
        ./run-docker.sh
        \`\`\`
        
        ### Kubernetesì— ë°°í¬
        \`\`\`bash
        kubectl apply -f k8s-deployment.yaml
        \`\`\`
        
        ## ğŸ“ ë¬¸ì˜
        
        ë¬¸ì œê°€ ìˆê±°ë‚˜ ì§ˆë¬¸ì´ ìˆìœ¼ì‹œë©´ ì´ìŠˆë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.
        EOF
        
        echo "ğŸ“¦ Release artifacts prepared"
        ls -la release-artifacts/
        
    - name: ğŸ“ ì•„í‹°íŒ©íŠ¸ íŒŒì¼ ì—…ë¡œë“œ
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: release-artifacts/run-docker.sh
        asset_name: run-docker.sh
        asset_content_type: application/x-sh
        
    - name: ğŸ“ Kubernetes ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì—…ë¡œë“œ
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: release-artifacts/k8s-deployment.yaml
        asset_name: k8s-deployment.yaml
        asset_content_type: application/x-yaml
        
    - name: ğŸ“ íŒ¨í‚¤ì§€ ì •ë³´ ì—…ë¡œë“œ
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: release-artifacts/package.json
        asset_name: package.json
        asset_content_type: application/json
        
    - name: ğŸ“ README ì—…ë¡œë“œ
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: release-artifacts/README.md
        asset_name: README.md
        asset_content_type: text/markdown

  # 5ë‹¨ê³„: ì•Œë¦¼ ë° ê²°ê³¼ ë¦¬í¬íŠ¸
  notify-result:
    name: Notify Build Result
    runs-on: ubuntu-latest
    needs: [build-and-test, docker-build-push, verify-image]
    if: always()
    
    steps:
    - name: ğŸ“§ ê²°ê³¼ ì´ë©”ì¼ ì•Œë¦¼
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: "[NCP] ${{ env.PROJECT_NAME }} ë¹Œë“œ ë° í‘¸ì‹œ ê²°ê³¼: ${{ needs.docker-build-push.result == 'success' && 'ì„±ê³µ' || 'ì‹¤íŒ¨' }}"
        to: ${{ secrets.NOTIFICATION_EMAIL }}
        from: ${{ secrets.EMAIL_USERNAME }}
        body: |
          ${{ env.PROJECT_NAME }} Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° NCP Container Registry í‘¸ì‹œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.

          ## ë¹Œë“œ ê²°ê³¼ ìš”ì•½
          - ğŸ“¦ ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸: ${{ needs.build-and-test.result }}
          - ğŸ³ Docker ë¹Œë“œ & í‘¸ì‹œ: ${{ needs.docker-build-push.result }}
          - ğŸ” ì´ë¯¸ì§€ ê²€ì¦: ${{ needs.verify-image.result }}

          ## í”„ë¡œì íŠ¸ ì •ë³´
          - í”„ë¡œì íŠ¸: ${{ env.PROJECT_NAME }}
          - ë ˆì§€ìŠ¤íŠ¸ë¦¬: ${{ env.REGISTRY_URL }}
          - ë¸Œëœì¹˜: ${{ github.ref_name }}
          - ì»¤ë°‹: ${{ github.sha }}
          - ë²„ì „: ${{ needs.build-and-test.outputs.version }}
          - íŠ¸ë¦¬ê±°: ${{ github.event_name }}
          - ì‘ì„±ì: ${{ github.actor }}

          ## Docker ì´ë¯¸ì§€
          ${{ needs.docker-build-push.result == 'success' && format('```
          {0}/{1}:latest
          {0}/{1}:{2}
          ```', env.REGISTRY_URL, env.PROJECT_NAME, needs.build-and-test.outputs.version) || 'ì´ë¯¸ì§€ ë¹Œë“œ ì‹¤íŒ¨' }}

          ## ì•¡ì…˜ ìƒì„¸ ë³´ê¸°
          ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          ---
          ì‹¤í–‰ ì‹œê°„: ${{ github.event.head_commit.timestamp }}
      if: always()
      
    - name: ğŸ“Š ì›Œí¬í”Œë¡œìš° ìš”ì•½
      run: |
        echo "## ğŸ¯ ë¹Œë“œ ë° í‘¸ì‹œ ì›Œí¬í”Œë¡œìš° ì™„ë£Œ ìš”ì•½" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| ë‹¨ê³„ | ê²°ê³¼ | ìƒíƒœ |" >> $GITHUB_STEP_SUMMARY
        echo "|------|------|------|" >> $GITHUB_STEP_SUMMARY
        echo "| ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸ | ${{ needs.build-and-test.result }} | ${{ needs.build-and-test.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Docker ë¹Œë“œ & í‘¸ì‹œ | ${{ needs.docker-build-push.result }} | ${{ needs.docker-build-push.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ì´ë¯¸ì§€ ê²€ì¦ | ${{ needs.verify-image.result }} | ${{ needs.verify-image.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“¦ ìƒì„±ëœ ì´ë¯¸ì§€" >> $GITHUB_STEP_SUMMARY
        echo "- **ë ˆì§€ìŠ¤íŠ¸ë¦¬**: \`${{ env.REGISTRY_URL }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **í”„ë¡œì íŠ¸**: \`${{ env.PROJECT_NAME }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **ë²„ì „**: \`${{ needs.build-and-test.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **ë¸Œëœì¹˜**: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
      if: always()